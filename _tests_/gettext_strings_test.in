#!/bin/sh

cd '@srcdir@'

tdir="$(mktemp -d "${TMPDIR:-/tmp}/tmp.XXXXXXXXXX")"

xgettext -f po/POTFILES.in -L C -o "$tdir/"skip.pot -x po/holy.pot --keyword=holy_util_info --keyword=holy_dprintf:1,2 --keyword=holy_register_command --keyword=holy_register_extcmd --keyword=holy_efiemu_resolve_symbol --keyword=holy_efiemu_register_symbol --keyword=holy_dl_load --keyword=holy_crypto_lookup_md_by_name --keyword=holy_crypto_lookup_cipher_by_name --keyword=holy_efiemu_resolve_symbol --keyword=alias --keyword=holy_ieee1275_get_property:2 --keyword=holy_ieee1275_find_device --keyword=holy_ieee1275_get_integer_property:2 --keyword=INIT_IEEE1275_COMMON:2  --keyword=holy_boot_time --keyword=holy_env_get --keyword=holy_env_set --keyword=holy_register_variable_hook --keyword=holy_fatal --keyword=__asm__ --keyword=volatile --keyword=__volatile__  --keyword=holy_error:2 --from-code=iso-8859-1
xgettext -f po/POTFILES.in -L C -o "$tdir/"skip2.pot -x po/holy.pot --keyword=volatile:2 --keyword=__volatile__:2 --keyword=holy_dprintf:2 --from-code=iso-8859-1
xgettext -f po/POTFILES.in -L C -o "$tdir/"skip3.pot -x po/holy.pot --keyword=volatile:3 --keyword=__volatile__:3 --from-code=iso-8859-1

cat po/POTFILES.in | xargs grep -hE -o "(  |    ){\"[a-z0-9\-]*\",[[:space:]]*('.'|[0-9]|-[0-9])," |sed "s,[[:space:]]*{\",,g;s,\"\,[[:space:]]*\('.'\|[0-9]\|-[0-9]\)\,,,g" | awk '{ print "msgid \"" $0 "\"\nmsgstr \"\"" ; }' > "$tdir/"opts.pot
cat po/POTFILES.in | xargs grep -hE -o "[[:space:]]*\.name[[:space:]]*=[[:space:]]*\"[a-zA-Z0-9 ()]*\"" |sed "s,[[:space:]]*\.name[[:space:]]*=[[:space:]]*\",,g;s,\",,g" | awk '{ print "msgid \"" $0 "\"\nmsgstr \"\"" ; }' > "$tdir/"name.pot

out="$(cat po/POTFILES.in | grep -v '\(colors.c\|lsefisystab.c\|lsefimmap.c\|lssal.c\|hdparm.c\|sendkey.c\|lsacpi.c\|lspci.c\|usbtest.c\|legacy_parse.c\|/libgcrypt/\|hfs.c\|/efi\.c$\|gnulib\|tests/\|util/ieee1275/ofpath.c\|minilzo.c\|terminfo.c\|setpci.c\|bin2h.c\|cb_timestamps.c\|holy-pe2elf.c\|getroot_[a-z]*.c\|getroot.c\|arc/init.c\|color.c\|holy-mklayout.c\|gentrigtables.c\|lzodefs.h\|lsefi.c\|cbls.c\|/zfs\.h$\|holy-macho2img.c\|syslinux_parse.c\|lvm.c\|efidisk.c\|holy-mkfont.c\|reiserfs.c\|LzmaEnc.c\)' | xgettext -f - -L C -o - -x po/holy.pot -x "$tdir/"skip.pot -x "$tdir/"skip2.pot -x "$tdir/"skip3.pot -x "$tdir/"opts.pot -x "$tdir/"name.pot -x po/exclude.pot -a --from-code=iso-8859-1)"
rm -rf "$tdir"
if [ x"$out" != x ]; then
    echo "$out"
    exit 1;
fi

